{% extends "baseframe.html" -%}
{% from 'baseframe/forms.html' import rendersubmit, renderfield %}
{% from 'macros.html' import edit_tags, tags_js %}

{% block footerscripts %}
<script>
$(function (){
    var page_changed = false;
    var autosave_interval = {{page.autosave or 0}};
    var editor = $('.CodeMirror')[0].CodeMirror;
    var page_form = $('form#new-or-edit-page');

    function save_page(){
        // check if the form has changed before trying to save
        if (page_changed){
            // get the text to the actual textarea from the cm
            editor.save();
            // then post it to be saved
            $.ajax({
                type: "POST",
                url:  page_form.attr('action'),
                data: page_form.serialize(),
                success: function(data){
                    if (data && data.path ){
                        page_form.attr('action', data.path + '/edit');
                        $('p#save_status').html('Page saved.')
                            .show().delay(1000).fadeOut();
                    }
                },
                dataType: "json",
                timeout: 5000   // timeout post after 5 secs.
            });
            page_changed = false;
        }
        autosave();
    }

$('form#edit-page').bind("keyup change", function(){
    page_changed = true;
});

function autosave() {
    setTimeout(save_page, autosave_interval)
};

if (autosave_interval){
    autosave();
}
});
{{tags_js(all_tags or [])}}
</script>
{% endblock %}

{% block basecontent %}
<h4>{{page.title or 'Create a New Page' }}</h4></br>

<p id='save_status' style='display:none;' class="alert alert-message fade in"></p>

{% if page %}
    <p>{{page.description.html}}</p>
{% endif %}

{% if page.title %}
    {% set action_url = url_for(page, 'edit') %}
{% else %}
    {% set action_url = url_for(page.parent, 'newpage') %}
{% endif %}

<form method="POST" id="new-or-edit-page" action='{{action_url}}'>
    {%- if form.errors %}
      <div class="alert alert-error">
        <a class="close" data-dismiss="alert">Ã—</a>
        Please correct the indicated errors.
      </div>
    {%- endif %}

{{form.hidden_tag()}}
{{renderfield(form.title)}}
{{renderfield(form.description, widget_css_class="codemirror")}}
{{renderfield(form.template)}}
{{edit_tags(form, page.tags or [])}}
{{rendersubmit([(None, "Submit", 'btn-primary')])}}
</form>

{% endblock %}
